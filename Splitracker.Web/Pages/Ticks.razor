@page "/Ticks"
@using Splitracker.Web.Shared.Characters
@using Splitracker.Web.Shared.Timelines
@using Splitracker.Domain

<PageTitle>Ticks - Splitracker</PageTitle>

@if (handle != null)
{
    <CascadingValue TValue="ITimelineDispatcher" Value="@this" IsFixed="@true">
        @if (handle.Timeline.Ready.Count > 0)
        {
            <TimelineReadyCharacters
                Characters="@handle.Timeline.Ready"
                SelectedTick="@selectedTick"/>
        }
        <TimelinePreview
            Timeline="handle.Timeline"
            OnTickSelected="@tickSelected"/>

        @* add character *@
        <MudBadge
            Icon="@Icons.Material.Filled.Add"
            Bordered="@true"
            Overlap="@true"
            Color="@Color.Primary"
            Style="right: 6.5rem; bottom: 1.5rem;"
            Class="fixed z-100">
            <MudFab
                DisableRipple="@true"
                StartIcon="@Icons.Material.Filled.EmojiPeople"
                Color="@Color.Primary"
                @onclick="toggleAddCharacterPanel"/>
        </MudBadge>

        @* add effect *@
        <MudBadge
            Icon="@Icons.Material.Filled.Add"
            Bordered="@true"
            Overlap="@true"
            Color="@Color.Primary"
            Style="right: 1.5rem; bottom: 1.5rem;"
            Class="fixed z-100">
            <MudFab
                DisableRipple="@true"
                StartIcon="@Icons.Material.Filled.CrisisAlert"
                Color="@Color.Primary"
                @onclick="toggleAddEffectPanel"/>
            @* Note: all of the popovers are attached to the rightmost FAB *@
            <MudPopover
                Open="@addCharacterPanelOpen"
                AnchorOrigin="@Origin.TopRight"
                TransformOrigin="@Origin.BottomRight"
                Fixed="@true"
                Style="max-width: 320px; z-index: 500">
                <CascadingValue TValue="ITimelineDispatcher" Value="@this" IsFixed="@true">
                    <TimelineAddCharacterCard
                        SelectedTick="@((selectedTick ?? handle.Timeline.Ticks.FirstOrDefault())?.At ?? 1)"
                        OnCharacterAdded="() => addCharacterPanelOpen = false"/>
                </CascadingValue>
            </MudPopover>
            <MudPopover
                Open="@addEffectPanelOpen"
                AnchorOrigin="@Origin.TopRight"
                TransformOrigin="@Origin.BottomRight"
                Fixed="@true"
                Style="max-width: 320px; z-index: 500">
                <TimelineCreateEffectCard
                    SelectedTick="@((selectedTick ?? handle.Timeline.Ticks.FirstOrDefault())?.At ?? 1)"
                    OnEffectCreated="() => addEffectPanelOpen = false"/>
            </MudPopover>
        </MudBadge>
    </CascadingValue>
}
else
{
    <MudProgressCircular
        Size="@Size.Large"
        Indeterminate="@true"/>
}